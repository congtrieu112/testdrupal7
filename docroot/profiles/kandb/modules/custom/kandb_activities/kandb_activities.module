<?php

/**
 * @file
 * K&B B2C Group pages Activities.
 */
define('KANDB_GROUP_ACTIVITES_HEADER_MENU_DEFAULT_TITLES', serialize(array(t('Habitat'), t('Tertiaire'), t('Nos agences'))));
define('KANDB_GROUP_ACTIVITES_HEADER_MENU_DEFAULT_LINKS', serialize(array('corporate/activites/habitat', 'corporate/activites/tertiaire', 'corporate/activites/nos-agences')));
define('NUMBER_CTA_ACTIVE', 3);
define('VOCAL_HABITAT', 'type_de_habitat');

/**
 * Implement of hook_menu().
 */
function kandb_activities_menu() {
  $items = array();

  $items['corporate/activites/habitat'] = array(
    'title' => 'Le Groupe - Activités - Habitat',
    'page callback' => 'render_group_activities_habitat',
    'type' => MENU_CALLBACK,
    'access arguments' => array('access content'),
  );

  $items['corporate/activites/nos-agences'] = array(
    'title' => 'Le Groupe - Activités - Nos agences',
    'page callback' => 'render_group_activities_nos_agences',
    'type' => MENU_CALLBACK,
    'access arguments' => array('access content'),
  );

  $items['corporate/activites/nos-services'] = array(
    'title' => 'Le Groupe - Activités - Nos agences',
    'page callback' => 'render_group_activities_nos_agences',
    'type' => MENU_CALLBACK,
    'access arguments' => array('access content'),
  );

  $items['corporate/activites/nos-showroom'] = array(
    'title' => 'Le Groupe - Activités - Nos agences',
    'page callback' => 'render_group_activities_nos_agences',
    'type' => MENU_CALLBACK,
    'access arguments' => array('access content'),
  );

  $items['admin/content/ketb/group/active/habitat'] = array(
    'title' => '[Activities] - Habitat',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('kandb_group_active_habitat_form'),
    'file' => 'kandb_group_active_habitat.admin.inc',
    'access arguments' => array('administer K&B Contact settings'),
    'type' => MENU_LOCAL_TASK,
  );

  $items['corporate/activites/habitat/%'] = array(
    'title' => 'Le Groupe - Activités - Habitat',
    'page callback' => 'render_group_activities_habitat_by_term',
    'page arguments' => array(3),
    'type' => MENU_CALLBACK,
    'access arguments' => array('access content'),
  );

  return $items;
}

/**
 * Implement of hook_theme().
 */
function kandb_activities_theme($existing, $type, $theme, $path) {
  return array(
    'group_activities_header' => array(
      'template' => 'templates/group_active_header',
      'variables' => array(),
    ),
    'group_activities_habitat' => array(
      'template' => 'templates/group_active_habitat',
      'variables' => array(),
    ),
    'group_activities_nos_agences' => array(
      'template' => 'templates/group_activities_nos_agences',
      'variables' => array(),
    ),
  );
}

/**
 * Implements render page habitat.
 */
function render_group_activities_habitat() {
  $data = array();
  if ($vocabulary = taxonomy_vocabulary_machine_name_load(VOCAL_HABITAT)) {
    $tree = taxonomy_get_tree($vocabulary->vid);
    if ($tree) {
      $data['type'] = $tree;
      if (isset($tree[0]->tid)) {
        $nodes = kandb_activities_get_habitat_node($tree[0]->tid);
        $data['nodes'] = $nodes;
        $data['active'] = $tree[0]->tid;
      }
    }
  }
  return theme('group_activities_habitat', array('data' => $data));
}

/**
 * Implements render page Nos agences.
 */
function render_group_activities_nos_agences() {
    $query = new EntityFieldQuery();
    $query->entityCondition('entity_type', 'node')
      ->entityCondition('bundle', 'region_kb');

  $regions = $query->execute();

  return theme('group_activities_nos_agences', array('region_contents' => $regions));
}

/**
 * Implement render habitat with term id.
 */
function render_group_activities_habitat_by_term($tid) {
  $data = array();
  if ($vocabulary = taxonomy_vocabulary_machine_name_load(VOCAL_HABITAT)) {
    $tree = taxonomy_get_tree($vocabulary->vid);
    if ($tree) {
      $data['type'] = $tree;
      if ($tid) {
        $nodes = kandb_activities_get_habitat_node($tid);
        $data['nodes'] = $nodes;
        $data['active'] = $tid;
      }
    }
  }
  return theme('group_activities_habitat', array('data' => $data));
}

/**
 * Get grouvernance lasted.
 */
function kandb_activities_get_habitat_node($tid = array()) {
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'habitat')
    ->propertyCondition('status', 1)
    ->fieldCondition('field_habitat_type', 'tid', $tid, '=')
    ->propertyOrderBy('changed', 'DESC')
  ;
  $result = $query->execute();

  if (isset($result['node'])) {
    $nids = array_keys($result['node']);
    return entity_load('node', $nids);
  }

  return NULL;
}
